<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test STL Viewer</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
        font-family: Arial, sans-serif;
      }
      #viewer-container {
        width: 100%;
        height: 500px;
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        position: relative;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-left-color: #00a8ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      select {
        padding: 10px;
        margin: 20px 0;
        font-size: 16px;
        background: #333;
        color: #fff;
        border: 1px solid #555;
        border-radius: 4px;
      }
      #console-log {
        margin-top: 20px;
        padding: 10px;
        background: #000;
        border: 1px solid #333;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-line {
        margin: 2px 0;
      }
      .log-error {
        color: #ff4444;
      }
      .log-success {
        color: #44ff44;
      }
      .log-info {
        color: #4444ff;
      }
    </style>
  </head>
  <body>
    <h1>STL Viewer Test</h1>

    <select id="model-selector">
      <option value="/assets/models/tisken_accesory_circle_v1.STL">
        Circular
      </option>
      <option value="/assets/models/tisken_accesory_horiz-rectang_v1.STL">
        Rectangular
      </option>
      <option value="/assets/models/tisken_accesory_triangle_v1.STL">
        Triangular
      </option>
      <option value="/assets/models/tisken_accesory_x_v1.STL">En X</option>
    </select>

    <div id="viewer-container">
      <div class="loading">
        <div class="spinner"></div>
        <p>Cargando Three.js...</p>
      </div>
    </div>

    <div id="console-log">
      <div class="log-line log-info">Console output:</div>
    </div>

    <script>
      // Custom console logger
      const logDiv = document.getElementById("console-log");
      const originalLog = console.log;
      const originalError = console.error;

      function addLog(message, type = "info") {
        const line = document.createElement("div");
        line.className = `log-line log-${type}`;
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      console.log = function (...args) {
        originalLog.apply(console, args);
        addLog(args.join(" "), "info");
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        addLog(args.join(" "), "error");
      };

      console.log("Starting test...");
      console.log("Three.js loading...");
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>

    <script>
      console.log("Three.js version:", THREE.REVISION);
      console.log(
        "OrbitControls available:",
        typeof THREE.OrbitControls !== "undefined",
      );
      console.log(
        "STLLoader available:",
        typeof THREE.STLLoader !== "undefined",
      );

      const container = document.getElementById("viewer-container");
      const loading = container.querySelector(".loading");

      // Scene setup
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x2a2a2a);
      console.log("Scene created");

      // Camera
      const camera = new THREE.PerspectiveCamera(
        75,
        container.clientWidth / 500,
        0.1,
        1000,
      );
      camera.position.z = 100;
      console.log("Camera created");

      // Renderer
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, 500);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);
      console.log("Renderer created");

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
      light1.position.set(1, 1, 1);
      scene.add(light1);

      const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
      light2.position.set(-1, -1, -1);
      scene.add(light2);
      console.log("Lights added");

      // Grid
      const gridHelper = new THREE.GridHelper(200, 20, 0x666666, 0x333333);
      scene.add(gridHelper);
      console.log("Grid added");

      // Controls
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      console.log("Controls added");

      // Animation
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
      console.log("Animation started");

      // Load model
      let currentMesh = null;

      function loadModel(path) {
        console.log("Loading model:", path);
        loading.style.display = "block";
        loading.querySelector("p").textContent = "Cargando modelo...";

        if (currentMesh) {
          scene.remove(currentMesh);
          if (currentMesh.geometry) currentMesh.geometry.dispose();
          if (currentMesh.material) currentMesh.material.dispose();
        }

        const loader = new THREE.STLLoader();

        loader.load(
          path,
          function (geometry) {
            console.log("✓ Model loaded successfully!");
            addLog("✓ Model loaded: " + path, "success");
            loading.style.display = "none";

            geometry.center();

            const material = new THREE.MeshPhongMaterial({
              color: 0x00a8ff,
              specular: 0x111111,
              shininess: 200,
            });

            currentMesh = new THREE.Mesh(geometry, material);
            scene.add(currentMesh);

            // Auto-scale
            const box = new THREE.Box3().setFromObject(currentMesh);
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            const cameraZ = Math.abs(maxDim / Math.sin(fov / 2)) * 1.5;
            camera.position.z = cameraZ;

            const center = box.getCenter(new THREE.Vector3());
            controls.target.copy(center);
            controls.update();

            console.log("Model dimensions:", size);
            console.log("Camera distance:", cameraZ);
          },
          function (xhr) {
            if (xhr.lengthComputable) {
              const percent = ((xhr.loaded / xhr.total) * 100).toFixed(0);
              console.log("Loading: " + percent + "%");
            }
          },
          function (error) {
            console.error("✗ Error loading model:", error);
            addLog("✗ Error: " + error, "error");
            loading.querySelector("p").textContent = "❌ Error al cargar";
          },
        );
      }

      // Load first model
      loadModel("/assets/models/tisken_accesory_circle_v1.STL");

      // Model selector
      document
        .getElementById("model-selector")
        .addEventListener("change", function (e) {
          loadModel(e.target.value);
        });

      // Resize handler
      window.addEventListener("resize", function () {
        camera.aspect = container.clientWidth / 500;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, 500);
      });
    </script>
  </body>
</html>
